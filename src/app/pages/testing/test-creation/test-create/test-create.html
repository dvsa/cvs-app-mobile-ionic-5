<ion-header>
  <ion-toolbar>
    <ion-title class="ion-margin-start">
      Test
    </ion-title>
    <ion-buttons slot="end">
      <ion-button
        class="review-and-submit-button"
        [ngClass]="{buttonOpacity: changeOpacity}"
        (click)="reviewTest()"
      >
        Review and submit
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-no-padding content-background-color-grey">
  <div class="error-banner" *ngIf="errorIncomplete && !allVehiclesCompletelyTested">
    {{TEST_CREATE_ERROR_BANNER}}
  </div>
  <ion-list
    class="full-dividers-list"
    [ngClass]="{'accessibility-max-width':appService.isAccessibilityTextZoomEnabled()}"
  >
    <ion-card class="card" *ngFor="let vehicle of testData.vehicles; let i = index">
      <ion-item class="ion-item-title ion-no-padding" (click)="onVehicleDetails(vehicle)">
        <img
          slot="start"
          class="vehicle-type-icon"
          src="./assets/imgs/{{getVehicleTypeIconToShow(vehicle)}}-icon.svg"
        />
        <div class="vehicle-detail-content">
          <h2 *ngIf="vehicle.techRecord.vehicleType !== VEHICLE_TYPE.TRL">
            <span class="ion-text-uppercase">{{ vehicle.vrm }}</span>
            <span
              class="ion-text-uppercase"
              *ngIf="vehicle.techRecord.vehicleType !== VEHICLE_TYPE.CAR &&
                         vehicle.techRecord.vehicleType !== VEHICLE_TYPE.MOTORCYCLE"
              >({{vehicle.techRecord.vehicleType}})
            </span>
            <span
              class="ion-text-uppercase"
              *ngIf="vehicle.techRecord.vehicleType === VEHICLE_TYPE.CAR ||
                         vehicle.techRecord.vehicleType === VEHICLE_TYPE.MOTORCYCLE"
              >({{vehicle.techRecord.vehicleType}})
            </span>
          </h2>
          <h2 *ngIf="vehicle.techRecord.vehicleType === VEHICLE_TYPE.TRL">
            {{ vehicle.trailerId }} (Trailer)
          </h2>
          <p class="vehicle-vin">{{ vehicle.vin }}</p>
        </div>
        <h3 class="vehicle-details ion-align-items-end">Details</h3>
        <ion-icon class="chevron-forward" slot="end" name="chevron-forward"></ion-icon>
      </ion-item>
      <ion-item
        class="bottom-divider"
        (click)="onCountryOfRegistration(vehicle)"
      >
        <div class="flex-wrapper-container">
          <h3 class="item-label">Country of registration</h3>
          <h3
            class="country-of-registration-status ion-align-items-end ion-text-nowrap"
            [ngClass]="{'accessibility-no-margin': appService.isAccessibilityTextZoomEnabled()}"
          >
            {{getCountryStringToBeDisplayed(vehicle)}}
          </h3>
        </div>

        <ion-icon class="chevron-forward" slot="end" name="chevron-forward"></ion-icon>
      </ion-item>
      <ion-item
        class="bottom-divider"
        [ngClass]="{'error-incomplete-item': errorIncomplete && !vehicle.euVehicleCategory}"
        (click)="onVehicleCategory(vehicle)"
      >
        <div class="flex-wrapper-container">
          <h3 class="item-label">EU vehicle category</h3>
          <h3 class="eu-vehicle-category-status ion-align-items-end" *ngIf="!vehicle.euVehicleCategory">Select</h3>
          <h3
            class="eu-vehicle-category-status ion-text-uppercase ion-text-nowrap ion-align-items-end"
            *ngIf="vehicle.euVehicleCategory"
          >
            {{displayVehicleCategoryKey(vehicle.euVehicleCategory)}}
          </h3>
        </div>

        <ion-icon
          slot="end"
          [ngClass]="{'vehicle-category-icon-data': vehicle.euVehicleCategory,
                          'chevron-forward': !vehicle.euVehicleCategory}"
          [name]="vehicle.euVehicleCategory ? 'checkmark' : 'chevron-forward'"
        ></ion-icon>
      </ion-item>
      <ion-item
        class="bottom-divider"
        [ngClass]="{'error-incomplete-item': errorIncomplete && !vehicle.odometerReading}"
        (click)="onOdometer(i)"
        *ngIf="!isVehicleOfType(vehicle,VEHICLE_TYPE.TRL)"
      >
        <div class="flex-wrapper-container">
          <h3 class="item-label">Odometer reading</h3>
          <h3
            class="odometer-reading-status ion-align-items-end"
            [ngClass]="{'odometer-reading-start': !doesOdometerDataExist(i)}"
          >
            {{getOdometerStringToBeDisplayed(i)}}
          </h3>
        </div>
        <ion-icon
          class="odometer-reading-icon"
          slot="end"
          [ngClass]="{'odometer-reading-icon-data': doesOdometerDataExist(i), 'odometer-reading-icon-no-data': !doesOdometerDataExist(i)}"
          [name]="doesOdometerDataExist(i) ? 'checkmark' : 'chevron-forward'"
        ></ion-icon>
      </ion-item>
      <ion-list class="full-dividers-list">
        <ion-item-sliding *ngFor="let vehicleTest of vehicle.testTypes" #slidingItem>
          <ion-item
            (click)="openTest(vehicle, vehicleTest)"
            class="bottom-divider"
            [ngClass]="{'error-incomplete-item': errorIncomplete && getTestTypeStatus(vehicle, vehicleTest) === commonFunc.capitalizeString(testCompletionStatus.IN_PROGRESS)}"
          >
            <div class="flex-wrapper-container">
              <h3 class="test-type">{{ vehicleTest.testTypeCategoryName }}</h3>
              <ion-text
                [color]="commonFunc.getTestResultColor(vehicleTest.testResult)"
              >
                <p
                  class="test-type-status test-result ion-align-items-end ion-text-uppercase"
                  *ngIf="isTestAbandoned(vehicleTest)"
                >
                  Abandoned
                </p>
              </ion-text>

              <h3
                class="test-type-status ion-align-items-end"
                [ngClass]="{'test-type-inProgress': getTestTypeStatus(vehicle, vehicleTest) !== commonFunc.capitalizeString(testCompletionStatus.EDIT)}"
                *ngIf="!isTestAbandoned(vehicleTest)"
              >
                {{getTestTypeStatus(vehicle, vehicleTest)}}
              </h3>
            </div>
            <ion-icon
              class="odometer-reading-icon"
              slot="end"
              [ngClass]="{'odometer-reading-icon-data': getTestTypeStatus(vehicle, vehicleTest) === commonFunc.capitalizeString(testCompletionStatus.EDIT),
                                  'odometer-reading-icon-no-data': getTestTypeStatus(vehicle, vehicleTest) !== commonFunc.capitalizeString(testCompletionStatus.EDIT),
                                  'accessibility-no-margin-left': appService.isAccessibilityTextZoomEnabled()}"
              [name]="getTestTypeStatus(vehicle, vehicleTest) === commonFunc.capitalizeString(testCompletionStatus.EDIT) ? 'checkmark' : 'chevron-forward'"
              *ngIf="!isTestAbandoned(vehicleTest)"
            ></ion-icon>
          </ion-item>
          <ion-item-options *ngIf="!isTestAbandoned(vehicleTest)">
            <ion-button
              color="dark"
              (click)="onAbandonVehicleTest(vehicle.techRecord.vehicleType, vehicleTest)"
            >
              Abandon
            </ion-button>
            <ion-button
              color="danger"
              (click)="onRemoveVehicleTest(vehicle, vehicleTest, slidingItem)"
            >
              Remove
            </ion-button>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>

      <ion-item
        class="btn-add-test"
        (click)="onAddNewTestType(vehicle)"
        [ngClass]="{'bottom-divider': vehicle.testTypes.length === 0}"
      >
        <span *ngIf="vehicle.testTypes.length === 0">Add a test type</span>
        <span *ngIf="vehicle.testTypes.length !== 0">Add a linked test</span>
        <ion-icon aria-hidden="true" name="add-circle-outline" slot="end"></ion-icon>
      </ion-item>
    </ion-card>

    <ion-card class="card" *ngIf="displayAddVehicleButton">
      <ion-item
        class="btn-add-test"
        (click)="addTrailer(visitService.visit.tests)"
      >
        <span>Add a {{doesHgvLgvExist ? "trailer" : "vehicle"}}</span>
        <ion-icon aria-hidden="true" name="add-circle-outline" slot="end"></ion-icon>
      </ion-item>
    </ion-card>
  </ion-list>
</ion-content>

<ion-footer>
  <ion-toolbar class="gray-toolbar">
    <ion-buttons slot="start"> </ion-buttons>
    <ion-buttons slot="end">
      <ion-button color="danger" (click)="onCancel()">Cancel test</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>
